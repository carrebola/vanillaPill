---
sidebar_position: 110
---

# Historia 9. Definición del mapping de acceso a la bd.

Como desarrollador web quiero crear las clases que me permitirán mapear las tablas de la base de datos.

## Conexión con la base de datos
En primer lugar vamos a crear y exportar la conexión con supabase en un archivo independiente.
Creamos el archivo `src/bd/supabase.js` y sus carpetas correspondientes

Copiamos el código de conexión que usamos en las pruebas de conexión y exportamos el objeto `supabase`

Este código es una clase llamada "Perfil" que se utiliza para interactuar con una tabla de base de datos llamada "perfiles".



```js title="supabase.js"
import { createClient } from '@supabase/supabase-js'
//Creando la conexión con supabase
const supabaseUrl = 'https://ptnlczuiuaotrscavujw.supabase.co'
const supabaseKey = 'xxxxxxxxxxxxxxxxxxxxxx9.eyJpc3xxxxxxxxxxxxxxxxxpdWFvdHJzY2F2dWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzcxNxxxxxxxxxxxzY2MTACaOtS_kudjpUTJlnV4VfNU_5tZn1N8T0Uj9DkNjIecs'

//exportamos la conexión
export const supabase = createClient(supabaseUrl, supabaseKey)
```
## Clase User
Vamos a crear la clase **User**. Esta, por el momento, nos permitirá registrarnos, crear una sesión y salir de la sesión.



```js title="user.js"
//Importamos la conexión a la base de datos
import { supabase } from "./supabase.js";

export class User {
  // Mapping de propiedades de la tabla perfiles
  constructor(email=null, password=null) {
    this.email =  email
    this.password = password
  }
  
  //crear registro (método static que se puede leer desde la clase sin necesidad de crear una instancia)
  
  //create
  static async signin(userData) {    
    let { user, error } = await supabase.auth.signUp(userData)
    
    if (error) {
      throw new Error(error.message)
    }
    console.log('usuario creado correctamente ', user);
    return new User(user.id, user.email, user.password)
  }

  //login
  static async login(userData){
  //USER LOGIN
      let { data, error } = await supabase.auth.signInWithPassword(userData)
      if(error){
        throw new Error(error.message)
      }
      return data
  }

  //logout
  static async logout(){
    //USER LOGOUT
    let { error } = await supabase.auth.signOut()
    if(error){
      throw new Error(error.message)
    }
  } 
}
```


## Clase Perfil

El procedimiento es el mismo. En este caso haremos el crud completo.

Primero importamos la conexión a la base de datos.
A continuación, mediante el contructor, mapeamos las propiedades de la tabla (por el momento solo los campos a los que vamos a acceder o utilizar)




La clase tiene una serie de propiedades, incluyendo "id", "nombre", "apellidos", "user_id", "estado", "rol", y "avatar".

Hay varios métodos definidos en la clase. Fijate que los métodos `signin(userData)`, `login(userData)`y `logout(userData)` son métodos `static`, es decir, se pueden llamar desde la misma clase sin necesidad de instanciar el objeto, usando, por ejemplo  `User.login(usuario)`.

Métodos:

- "getAll()": Este método devuelve todos los registros de la tabla "perfiles" como un array de objetos.
- "getById(id)": Este método devuelve un registro específico de la tabla "perfiles" según su "id".
- "create(perfilData)": Este método crea un nuevo registro en la tabla "perfiles" utilizando los datos proporcionados en el parámetro "perfilData".
- "update()": Este método actualiza un registro existente en la tabla "perfiles" utilizando las propiedades de la instancia actual de la clase "Perfil".
- "delete(id)": Este método elimina un registro específico de la tabla "perfiles" según su "id".

Este sería el códigoo:

```js title="perfil.js"
//Importamos la conexión a la base de datos
import { supabase } from "./supabase.js";


export class Perfil {
  // Mapping de propiedades de la tabla perfiles
  constructor(id=null, nombre=null, apellidos=null, user_id=null, estado=null, rol=null, avatar=null) {
    this.id = id
    this.nombre = nombre
    this.apellidos = apellidos
    this.user_id = user_id
    this.estado = estado
    this.rol = rol
    this.avatar = avatar
  }

  //leer todos
  static async getAll() {
    const { data: perfiles, error } = await supabase
      .from('perfiles')
      .select('*')

    if (error) {
      throw new Error(error.message)
    }

    //devuelve array de objetos 
    return perfiles.map(({ id, nombre, apellidos, user_id, estado, rol, avatar }) => {
      return new Perfil(id, nombre, apellidos, user_id, estado, rol, avatar)
    })
  }

  //leer registro por id (método static que se puede leer desde la clase sin necesidad de crear una instancia)
  static async getById(id) {
    const { data: perfil, error } = await supabase
      .from('perfiles')
      .select('*')
      .eq('id', id)
      .single()

    if (error) {
      throw new Error(error.message)
    }

    return new Perfil(perfil.id, perfil.nombre, perfil.apellidos, perfil.user_id, perfil.estado, perfil.rol, perfil.avatar)
  }
  
  //crear registro (método static que se puede leer desde la clase sin necesidad de crear una instancia)
  static async create(perfilData) {    
    const { error } = await supabase
      .from('perfiles')
      .insert(perfilData)
      .select()
      //console.log('nuevo perfil ',error);
    if (error) {
      throw new Error(error.message)
    }
  }

  //actualizar
  async update() {
    const { error } = await supabase
      .from('perfiles')
      .update({
        nombre: this.nombre,
        apellidos: this.apellidos,
        avatar: this.avatar
      })
      .eq('id', this.id)
      .single()

    if (error) {
      throw new Error(error.message)
    }
  }

  //borrar
  static async delete(id) {
    const { error } = await supabase
      .from('perfiles')
      .delete()
      .eq('id', id)

    if (error) {
      throw new Error(error.message)
    }
  }
}
```





