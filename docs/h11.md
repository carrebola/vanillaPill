---
sidebar_position: 130
---

# Historia 11. Primeros componentes vanillaJS: header y router

Antes de comenzar vamos a trabajar sobre una rama nueva que llamaremos **vistas**.

## Componente Header
Al principio del proyecto creamos un componente **header** básico con la siguiente estructura:

```js title="header.js"
export const header = {
  template: 'header',
  script: ()=>{
    console.log('header)
  }
}
```

Vamos a actualizar la propiedad template de este componente con el código correspondiente al header de nuestro prototipo html. 

Este componente contendrá una barra de navegación básica responsive basada en navbar de bootstrap. También tendremos un icono para acceder al menú del usuario con las opciones:
- login/logout
- registro
- administración de usuarios

Más adelante actualizaremos el header para adaptarlo a las nuevas funcionalidades.

Pero antes necesitamos crear la carpeta `src/assets` para almacenar las imagenes del logotipo (**logo_vanilla.svg**) y el avatar del usuario cuando la sesión está cerrada (**avatar.svg**).

Nuestro componente header quedará así:

```js title="header.js"
export const header = {
  template: `
  
<!-- Navbar  -->
<nav class="navbar navbar-expand-sm bg-light fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="/">
      <img
        src="/assets/logo_vanilla.svg"
        alt="Logo"
        width="30"
        height="30"
        class="d-inline-block align-text-top me-2"
      />
      <span class=""></span>
      Vanilla Games
    </a>
    
    <button
      class="navbar-toggler ms-auto
      "
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNavDropdown"
      aria-controls="navbarNavDropdown"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">	
      <ul class="navbar-nav">	
        <li class="nav-item">
          <a class="nav-link" href="item1.html">Item 1</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="item2.html">Item 2</a>
        </li>
        <li><hr /></li>
        
        <li class="nav-item">
          <a class="nav-link" href="item3.html">Item 3</a>
        </li>
        
      </li>
      </ul>
      
    </div>
    <!-- login -->
    <ul class="navbar nav me-5">
      <li class="nav-item dropdown">
        <a
          class="nav-link dropdown-toggle"
          href="#"
          role="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <div class="avatarLogin d-inline-block">
            <img
              src="/assets/avatar.svg"
              alt="Logo"
              width="30"
              height="30"
              class="d-inline-block align-text-top"
            />
          </div>
        </a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="login.html">Login</a></li>
          <li>
            <a class="dropdown-item" href="registro.html">Registrate</a>
          </li>
          <li>
            <a
              data-bs-toggle="modal"
              data-bs-target="#editar"
              class="dropdown-item"
              href="editarPerfil.html"
              >Editar perfil</a
            >
          </li>
          <div class="dropdown-divider"></div>
          <li>
            <a class="dropdown-item" href="adminUsuarios.html">Admin Usuarios</a>
          </li>
        </ul>
    </ul> 
  </div>
</nav>
```

Vamos a añadir ahora al header una ventana modal que nos permitirá editar el perfil del usuario logueado cuando hacemos click sobre la opción de menú correspondiente.

Para ello vamos a crear un componente `formEditarUsuario.js`

## formEditarUsuario
Este componente tendrá la misma estructura que el anterior, una propiedad template para el código html correspondiente al formulario, y un método script que incluirá toda la lógica (validación y conexión con la base de datos), y que programaremos más adelante.

```js title="formEditarUsuario.js"
export const formEditarUsuario = {
  template: `
    
<!-- Modal -->
<div class="modal fade" id="editar">
<div class="modal-dialog" role="document">
    <div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title">Editar usuario</h5>
        <button
        type="button"
        class="btn-close"
        data-bs-dismiss="modal"
        aria-label="Close"
        >
        <span aria-hidden="true"></span>
        </button>
    </div>
    <div class="modal-body">
        <form class="p-3">
        <label class="mt-3 form-label" for="nick">Nombre: </label>
        <input id="nombre" type="text" class="form-control" value="" />

        <label class="mt-3 form-label" for="apellidos">Apellidos: </label>
        <input id="apellidos" type="text" class="form-control" value="" />

        <label class="mt-3 form-label" for="email">Email</label>
        <input
            id="email"
            type="email"
            class="form-control"
            value="email@gmail.com"
        />

        <label class="mt-3 form-label" for="contraseña">Contraseña: </label>
        <input id="contraseña" type="password" class="form-control" value="123456" />
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary">
        Guardar cambios
        </button>
        <button
        type="button"
        class="btn btn-secondary"
        data-bs-dismiss="modal"
        >
        Cerrar
        </button>
    </div>
    </div>
</div>
</div>
  `
}
```

Ahora solo falta inyectar este componente en el código html del componente header. Para ello importamos en `header.js`el componente con `import { formEditarUsuario } from './formEditarUsuario'` 

y insertamos su template al final del código html de nuestro componente header: 
```js title="header.js"
  ...

    </div>
  </nav>

  //Modals
  ${formEditarUsuario.template}
`
}
```
## Componente Router
Vamos a crear el código neceario para la implementación de un sistema de enrutamiento para una SPA (Single Page Application) en vanilla JavaScript.

En primer lugar vamos a definir un objeto llamado `enrutador`. Este objeto tendrá como propiedad otro objeto llamado `rutas`. Este objeto va a tener tantas propiedades como vistas contenga nuestro proyecto. Por lo tanto, conforme vayamos creando nuevas vistas las iremos añadiendo aquí.

Fíjate que cada propiedad terndrá como valor cada uno de los  componentes (vistas) de nuestro proyecto, es decir, objetos con la propiedad template y el método script() 

Por lo tanto, las vistas se importan dinámicamente usando el método import().

```js title="router.js"
// Objeto con todas las rutas y su vista asociada
rutas: {
    home: import('../vistas/homeVista.js'),
    // Usuarios
    adminUsuarios: import('../vistas/admin/adminVista.js'),
    registro: import('../vistas/registroVista.js'),
    login: import('../vistas/loginVista.js'),
    // Proyectos
    proyectos: import('../vistas/proyectos/proyectosVista.js'),
    nuevoProyecto: import('../vistas/proyectos/nuevoProyectoVista.js'),
    editarProyecto: import('../vistas/proyectos/editarProyectoVista.js'),
    detalleProyecto: import('../vistas/proyectos/detalleProyectoVista.js'),
    misProyectos: import('../vistas/proyectos/misProyectosVista.js')
  },
```
Ahora vamos a crear el método `router`. Esta será la que maneje el enrutamiento en la aplicación. 

Esta función se dispara cada vez que se produce un cambio en la url del navegador. 

Para navegar a través de las vistas sin tener que recargar la página utilizaremos el hash `#`. Por ejemplo, para navegar a la página home la url sería www.mihost.com/#/home

Dentro del método router() se obtiene el hash de la ruta modificada mediante `window.location.hash`. 

Después, se utiliza este hash resultante para obtener la vista correspondiente del objeto rutas.

Si la vista existe, se obtiene el objeto de la vista mediante la propiedad **default** de la promesa. 

Luego, se inyecta la vista en el elemento main del documento HTML utilizando la propiedad **innerHTML** de document.querySelector('main'). Por último, se ejecuta el **script** de la vista si lo hay.



```js title="router"
// Método que obtiene la ruta del navegador
  router: async () => {
    // Capturamos el hash # que ha cambiado en la url
    const pathCompleto = window.location.hash
    // Separamos la ruta del posible parametro que reciba
    const path = pathCompleto.split('/')[1]
    const parametro = pathCompleto.split('/')[2]

    // capturamos el componente con ese nombre de la vista
    // (Usamos las sintaxix objeto[propiedad]) porque el nombre de la propiedad lo tenemos en una variable.)
    const componenteVista = await enrutador.rutas[path]
    // Si existe la vista la podremos cargar
    if (componenteVista) {
      try {
        // Obtenemos el objeto del componente (que fué exportado como default)
        const vista = await componenteVista.default
        // inyectamos vista y ejecutamos su script
        document.querySelector('main').innerHTML = vista.template
        // A los script les pasamos el parametro que hemos extraido de la ruta. Así podemos pasar, por ejemplo, el id de un proyecto
        vista.script(parametro)
      } catch (error) {
        // Si se produce un error cargamos la vista 404
        console.log(error)
      }
    }
  },
```
La función **observadorRutas** es una función que se encarga de escuchar los eventos de enrutamiento en la aplicación. 

En esta función, se capturan los eventos de click en los enlaces, y se evita que se cargue la página utilizando el método preventDefault(). 

Luego, se obtiene la ruta del enlace utilizando el método **getAttribute('href')**. Se utiliza la función **pushState()** del objeto **history** para agregar la nueva ruta al historial del navegador sin recargar la página. 

Finalmente, se llama a la función **router()** para cargar la nueva vista correspondiente a la ruta.

Ahora necesitamos detectar que se ha producido un cambio en el historial de nuestro navegador. Para ello detectaremos el evento popstate del objeto window y llamaremos al método router() para actualizar la vista.

```js
  // Detectamos cuando alguien navega por el historial con los botones avanzar y retroceder del navegador.
    window.addEventListener('popstate', (e) => {
      console.log('evento popstate - Te estás moviendo por el historial')
      enrutador.router()
    })
```

Para completar nuestro enrutador solo nos falta detectar cuando alguien hace click sobre un enlace (etiqueta `<a href="vista"></a>`).
Para ello, en nuestro método `observadorRutas()` añadimos el observador
 `document.body.addEventListener('click', event => { ` 

A continuación comprobamos si el click se ha producido sobre un elemento de tipo `<a>`. Si es así, extraemos el contenido del atributo href y añadimos al historial de windows la nueva ruta. Ahora router() se encargará de extraer de esta url la vista que debe cargarse y procederá a inyectarla en nuestro `<main>`

Con esta lógica podemos detectar: 
- cuando se pulsa sobre un enlace (etiqueta `<a>`), 
- cuando se navega por el historial o 
- cuando se introduce directamente una url en la barra de navegación 
para poder cargar la vista correspondiente

El código completo quedaría así:

```js title="router.js"
    document.body.addEventListener('click', event => {
```

Ahora solo faltaría añadir a la página principal `main.js` una llamada al método observadorRutas() de nuestro objeto para que escuche los posibles eventos.

Tambien vamos a eliminar la inyección manual que hacíamos sobre la etiqueta main para usar `windows.location = '#/home'` y asociar así la vista home a la raiz de la app.

```js title="main.js"
// Import our custom CSS
import './scss/styles.scss'
// Import all of Bootstrap's JS
import * as bootstrap from 'bootstrap'

// Importamos componentes header y footer
import { header } from './componentes/header'
import { footer } from './componentes/footer'

// Importamos la Función para detectar eventos al cargar las vistas
import { enrutador } from './componentes/enrutador'

document.querySelector('#header').innerHTML = header.template
header.script()
document.querySelector('#footer').innerHTML = footer.template

enrutador.observadorRutas()

// Cargamos la página home
window.location = '#/home'
```

## Versión 2.0 de header

Para mejorar nuestro header vamos a dividir el componente en tres componentes, el header que contendrá el html que no cambia nunca, y dos componentes más: **menuSuperior.js** y **menuUsuario.js**. 

Estos componentes contendrán el código correspondiente a los menús, que será diferente, dependiendo del usuario que esté logueado.

También vamos a añadir la lógica necesaria para detectar si hay una sesión abierta y capturar los datos del usuario (su perfil).

A continuación llamaremos a los métodos script de los menús pasandoles el perfil del usuario logueado para que estos, dependiendo del rol del usuario, muestren los items correspondientes. 
Este es el código actualizado de header: 

```js title="header.js"
import { formEditarPerfil } from './formEditarPerfil'
import { User } from '../bd/user'
import { Perfil } from '../bd/perfil'
import { menuSuperior } from './menuSuperior'
import { menuUsuario } from './menuUsuario'

export const header = {
  template: `
  
<!-- Navbar  -->
<nav class="navbar navbar-expand-sm bg-light fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#/home">
      <img
        src="/assets/logo_vanilla.svg"
        alt="Logo"
        width="30"
        height="30"
        class="d-inline-block align-text-top me-2"
      />
      <span class=""></span>
      Vanilla Games
    </a>
    
    <button
      class="navbar-toggler ms-auto
      "
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNavDropdown"
      aria-controls="navbarNavDropdown"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
    <span class="navbar-toggler-icon"></span>
    </button>
    <!-- Menú superior -->
    ${menuSuperior.template}
    <!-- Menu usuario -->
    ${menuUsuario.template}
  </div>
</nav>

//Modals
${formEditarPerfil.template}
  `,
  script: async () => {
    try {
      // Capturamos los datos del usuario logueado
      const usuarioLogueado = await User.getUser()
      if (usuarioLogueado) {
        const perfilLogueado = await Perfil.getByUserId(usuarioLogueado.id)
        // cargamos el menú superior y usuario para su rol
        menuSuperior.script(perfilLogueado)
        menuUsuario.script(perfilLogueado)
      } else {
        menuSuperior.script('anonimo')
        menuUsuario.script('anonimo')
      }
    } catch (error) {
      // alert('No he podido cargar el usuario logueado')
    }
  }
}
```


## Componente menuSuperior

```js title="menuSuperior"
import { formEditarPerfil } from './formEditarPerfil'
import { User } from '../bd/user'
import { Perfil } from '../bd/perfil'
import { menuSuperior } from './menuSuperior'
import { menuUsuario } from './menuUsuario'

export const header = {
  template: `
  
<!-- Navbar  -->
<nav class="navbar navbar-expand-sm bg-light fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#/home">
      <img
        src="/assets/logo_vanilla.svg"
        alt="Logo"
        width="30"
        height="30"
        class="d-inline-block align-text-top me-2"
      />
      <span class=""></span>
      Vanilla Games
    </a>
    
    <button
      class="navbar-toggler ms-auto
      "
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNavDropdown"
      aria-controls="navbarNavDropdown"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
    <span class="navbar-toggler-icon"></span>
    </button>
    <!-- Menú superior -->
    ${menuSuperior.template}
    <!-- Menu usuario -->
    ${menuUsuario.template}
  </div>
</nav>

//Modals
${formEditarPerfil.template}
  `,
  script: async () => {
    try {
      // Capturamos los datos del usuario logueado
      const usuarioLogueado = await User.getUser()
      if (usuarioLogueado) {
        const perfilLogueado = await Perfil.getByUserId(usuarioLogueado.id)
        // cargamos el menú superior y usuario para su rol
        menuSuperior.script(perfilLogueado)
        menuUsuario.script(perfilLogueado)
      } else {
        menuSuperior.script('anonimo')
        menuUsuario.script('anonimo')
      }
    } catch (error) {
      // alert('No he podido cargar el usuario logueado')
    }
  }
}

```

## Componente menuUsuario
```js title="menuUsuario.js"
import { formEditarPerfil } from './formEditarPerfil'
import { User } from '../bd/user'
import { Perfil } from '../bd/perfil'
import { menuSuperior } from './menuSuperior'
import { menuUsuario } from './menuUsuario'

export const header = {
  template: `
  
<!-- Navbar  -->
<nav class="navbar navbar-expand-sm bg-light fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#/home">
      <img
        src="/assets/logo_vanilla.svg"
        alt="Logo"
        width="30"
        height="30"
        class="d-inline-block align-text-top me-2"
      />
      <span class=""></span>
      Vanilla Games
    </a>
    
    <button
      class="navbar-toggler ms-auto
      "
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNavDropdown"
      aria-controls="navbarNavDropdown"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
    <span class="navbar-toggler-icon"></span>
    </button>
    <!-- Menú superior -->
    ${menuSuperior.template}
    <!-- Menu usuario -->
    ${menuUsuario.template}
  </div>
</nav>

//Modals
${formEditarPerfil.template}
  `,
  script: async () => {
    try {
      // Capturamos los datos del usuario logueado
      const usuarioLogueado = await User.getUser()
      if (usuarioLogueado) {
        const perfilLogueado = await Perfil.getByUserId(usuarioLogueado.id)
        // cargamos el menú superior y usuario para su rol
        menuSuperior.script(perfilLogueado)
        menuUsuario.script(perfilLogueado)
      } else {
        menuSuperior.script('anonimo')
        menuUsuario.script('anonimo')
      }
    } catch (error) {
      // alert('No he podido cargar el usuario logueado')
    }
  }
}

```