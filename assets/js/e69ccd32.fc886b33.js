"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1284],{3905:(e,a,n)=>{n.d(a,{Zo:()=>d,kt:()=>g});var r=n(7294);function o(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function t(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);a&&(r=r.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?t(Object(n),!0).forEach((function(a){o(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function l(e,a){if(null==e)return{};var n,r,o=function(e,a){if(null==e)return{};var n,r,o={},t=Object.keys(e);for(r=0;r<t.length;r++)n=t[r],a.indexOf(n)>=0||(o[n]=e[n]);return o}(e,a);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(r=0;r<t.length;r++)n=t[r],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var i=r.createContext({}),c=function(e){var a=r.useContext(i),n=a;return e&&(n="function"==typeof e?e(a):s(s({},a),e)),n},d=function(e){var a=c(e.components);return r.createElement(i.Provider,{value:a},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var a=e.children;return r.createElement(r.Fragment,{},a)}},p=r.forwardRef((function(e,a){var n=e.components,o=e.mdxType,t=e.originalType,i=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=c(n),p=o,g=u["".concat(i,".").concat(p)]||u[p]||m[p]||t;return n?r.createElement(g,s(s({ref:a},d),{},{components:n})):r.createElement(g,s({ref:a},d))}));function g(e,a){var n=arguments,o=a&&a.mdxType;if("string"==typeof e||o){var t=n.length,s=new Array(t);s[0]=p;var l={};for(var i in a)hasOwnProperty.call(a,i)&&(l[i]=a[i]);l.originalType=e,l[u]="string"==typeof e?e:o,s[1]=l;for(var c=2;c<t;c++)s[c]=n[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},3176:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>i,contentTitle:()=>s,default:()=>m,frontMatter:()=>t,metadata:()=>l,toc:()=>c});var r=n(7462),o=(n(7294),n(3905));const t={title:"Gesti\xf3n de sesiones (login y logout)"},s=void 0,l={unversionedId:"Version 1.0/SPRINT 3 - SPA/Dando funcionalidad a las vistas/Sesiones",id:"Version 1.0/SPRINT 3 - SPA/Dando funcionalidad a las vistas/Sesiones",title:"Gesti\xf3n de sesiones (login y logout)",description:"Ahora ya tenemos nuestra app funcionando visualmente. El enrutador se encarga de mostrar las vistas como si de p\xe1ginas independientes se tratase.",source:"@site/docs/03-Version 1.0/SPRINT 3 - SPA/06-Dando funcionalidad a las vistas/01-Sesiones.md",sourceDirName:"03-Version 1.0/SPRINT 3 - SPA/06-Dando funcionalidad a las vistas",slug:"/Version 1.0/SPRINT 3 - SPA/Dando funcionalidad a las vistas/Sesiones",permalink:"/vanillaPill/docs/Version 1.0/SPRINT 3 - SPA/Dando funcionalidad a las vistas/Sesiones",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/03-Version 1.0/SPRINT 3 - SPA/06-Dando funcionalidad a las vistas/01-Sesiones.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Gesti\xf3n de sesiones (login y logout)"},sidebar:"tutorialSidebar",previous:{title:"Subcomponentes de header (Men\xfas y editar perfil)",permalink:"/vanillaPill/docs/Version 1.0/SPRINT 3 - SPA/Componente menu"},next:{title:"Vista proyectos",permalink:"/vanillaPill/docs/Version 1.0/SPRINT 3 - SPA/Dando funcionalidad a las vistas/Vista proyectos"}},i={},c=[{value:"Datos para simular el acceso a la base de datos",id:"datos-para-simular-el-acceso-a-la-base-de-datos",level:2},{value:"Implementando el Login a trav\xe9s de localstorage",id:"implementando-el-login-a-trav\xe9s-de-localstorage",level:2},{value:"Cerrando sesi\xf3n",id:"cerrando-sesi\xf3n",level:2}],d={toc:c},u="wrapper";function m(e){let{components:a,...n}=e;return(0,o.kt)(u,(0,r.Z)({},d,n,{components:a,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Ahora ya tenemos nuestra app funcionando visualmente. El enrutador se encarga de mostrar las vistas como si de p\xe1ginas independientes se tratase."),(0,o.kt)("p",null,"Vamos a darle otra vuelta de tuerca a las vistas aport\xe1ndole funcionalidades extras. "),(0,o.kt)("p",null,"Por el momento ",(0,o.kt)("strong",{parentName:"p"},"no vamos a conectarnos con el backend"),", sino que nos valdremos de ",(0,o.kt)("strong",{parentName:"p"},"datos simulados")," que cargaremos en un archivo a partir de datos en formato ",(0,o.kt)("strong",{parentName:"p"},"json")," (objetos en javascript) que simular\xe1n las consultas a nuestra base de datos."),(0,o.kt)("admonition",{title:"Nueva rama 'l\xf3gica para vistas'",type:"danger"},(0,o.kt)("p",{parentName:"admonition"},"Para esta parte del trabajo vamos a crear la rama 'logica para vistas'")),(0,o.kt)("h2",{id:"datos-para-simular-el-acceso-a-la-base-de-datos"},"Datos para simular el acceso a la base de datos"),(0,o.kt)("p",null,"\xbfQu\xe9 tal si comenzamos con un objeto que contenga los datos de diferentes usuarios registrados? Para concretar el nombre de las propiedades deber\xedamos basarnos en el diagrama de clases que hemos creado cuando llevabamos el traje de backend."),(0,o.kt)("p",null,"Digamos que, tras consultar con nuestro ",(0,o.kt)("strong",{parentName:"p"},"'yo-programador' encargado del backend"),", hemos decidido que puede ser algo as\xed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"perfiles = [\n  {\n    id: 1\n    created_at:\n    user_id:\n    nombre:\n    apellidos:\n    avatar:\n    estado:\n    rol:\n    email:\n    contrase\xf1a:\n  }\n]\n\n")),(0,o.kt)("p",null,"Con un poquito de inteligencia artificial, tenemos un array de datos inventados que podemos guardar en un archivo js. "),(0,o.kt)("p",null,"Crea una carpeta ",(0,o.kt)("inlineCode",{parentName:"p"},"bd"),"en la raiz y crea dentro el archivo ",(0,o.kt)("inlineCode",{parentName:"p"},"datosPrueba.js")," con el siguiente c\xf3digo:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"export const perfiles = [\n  {\n    id: 1,\n    created_at: '2023-08-28',\n    user_id: '8e9b7c4f-10de-4a10-a36e-87f49657d1c1',\n    nombre: 'Paco',\n    apellidos: 'Mart\xednez Soria',\n    avatar: 'https://e00-elmundo.uecdn.es/assets/multimedia/imagenes/2022/02/28/16460502314689.jpg',\n    estado: 'Activo',\n    rol: 'registrado',\n    email: 'paco@example.com',\n    contrase\xf1a: '123456'\n  },\n  {\n    id: 2,\n    created_at: '2023-08-29',\n    user_id: '36f66b5e-aa59-4f96-b6a8-3c890d6a452c',\n    nombre: 'Carmen',\n    apellidos: 'Maura',\n    avatar: 'https://s.libertaddigital.com/2020/09/15/1920/1080/fit/carmen-maura-roman.jpg',\n    estado: 'Inactivo',\n    rol: 'desarrollador',\n    email: 'carmen@example.com',\n    contrase\xf1a: '123456'\n  },\n  {\n    id: 3,\n    created_at: '2023-08-30',\n    user_id: 'a3df05b0-91e7-4f68-a067-841fcf5de9f0',\n    nombre: 'Antonio',\n    apellidos: 'Resines',\n    avatar: 'https://estaticos-cdn.elperiodico.com/clip/056573ce-f784-49d0-9746-0e154380598b_alta-libre-aspect-ratio_default_0.jpg',\n    estado: 'Activo',\n    rol: 'desarrollador',\n    email: 'antonio@example.com',\n    contrase\xf1a: '123456'\n  },\n  {\n    id: 4,\n    created_at: '2023-08-31',\n    user_id: 'd67e3b1c-875f-437f-bd2a-9ff50b72083d',\n    nombre: 'Maribel',\n    apellidos: 'Verd\xfa',\n    avatar: 'https://es.web.img3.acsta.net/pictures/23/06/13/09/44/5805084.jpg',\n    estado: 'Inactivo',\n    rol: 'desarrollador',\n    email: 'maribel@example.com',\n    contrase\xf1a: '123456'\n  },\n  {\n    id: 5,\n    created_at: '2023-09-01',\n    user_id: '2419d5e3-46a6-45d6-98a2-b02c8ac5d3fe',\n    nombre: 'Javier',\n    apellidos: 'Bardem',\n    avatar: '',\n    estado: 'Activo',\n    rol: 'admin',\n    email: 'javier@example.com',\n    contrase\xf1a: '123456'\n  }\n]\n\n")),(0,o.kt)("h2",{id:"implementando-el-login-a-trav\xe9s-de-localstorage"},"Implementando el Login a trav\xe9s de localstorage"),(0,o.kt)("p",null,"Comencemos por la vista login."),(0,o.kt)("p",null,"Vamos a crear la l\xf3gica para que cuando un usuario ",(0,o.kt)("strong",{parentName:"p"},"inicie sesi\xf3n")," la informaci\xf3n del usuario se guarde en el ",(0,o.kt)("strong",{parentName:"p"},"localstorage"),". "),(0,o.kt)("p",null,"Creamos una funci\xf3n ",(0,o.kt)("inlineCode",{parentName:"p"},"enviarDatos(formulario)")," que recibe el formulario, (en caso de que \xe9ste valide) y extraemos los valores de los campos para, de momento, sacarlos por consola"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="login.js"',title:'"login.js"'},"import { perfiles } from '../bd/datosPrueba'\n\nexport default {\n  template: // html\n  `...`,\n\n  script: () => {\n    console.log('vista login cargada')\n    // Validaci\xf3n bootstrap\n\n    // Capturamos el formulario en una variable\n    const formulario = document.querySelector('#formulario')\n    // Detectamos su evento submit (enviar)\n    formulario.addEventListener('submit', (event) => {\n      // Detenemos el evento enviar (submit)\n      event.preventDefault()\n      event.stopPropagation()\n      // Comprobamos si el formulario no valida\n      if (!formulario.checkValidity()) {\n        // Y a\xf1adimos la clase 'was-validate' para que se muestren los mensajes\n      formulario.classList.add('was-validated')\n        console.log('No valida')\n      } else {\n        enviarDatos(formulario)\n      }\n      \n    })\n\n    function enviarDatos (formulario) {\n      const email = formulario.email.value\n      const pass = formulario.password.value\n      console.log('email y pass: ', email, pass)\n    }\n  }\n}\n\n")),(0,o.kt)("p",null,"Para que este c\xf3digo funcione debes actualizar los inputs del formulario para que incorporen el atributo name."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'  <input id="email" name="email" value="ejemplo@email.com" required type="email" class="form-control" />\n')),(0,o.kt)("p",null,"Ahora vamos a comprobar que el email existe y que la contrase\xf1a corresponde con la informaci\xf3n de la base de datos. Para ello utilizaremos las '",(0,o.kt)("em",{parentName:"p"},"array functions"),"' que hemos estudiado en clase."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"function enviarDatos (formulario) {\n  const email = formulario.email.value\n  const pass = formulario.password.value\n\n  // buscamos el indice del email en el array perfiles\n  const indexUser = perfiles.findIndex((user) => user.email === email)\n  // Si existe y la contrase\xf1a corresponde\n  if (perfiles[indexUser].contrase\xf1a === pass) {\n    console.log('\xa1login correcto!')\n  } else {\n    console.log('El usuario no existe o la contrase\xf1a no corresponde')\n  }\n}\n\n")),(0,o.kt)("p",null,"Ahora solo falta registrar los datos del usuario en el localstorage (esta vez con algunos datos extra como el user_id). Usaremos nuestro objeto ",(0,o.kt)("inlineCode",{parentName:"p"},"ls")," por lo que no olvides cargar la libreria ",(0,o.kt)("inlineCode",{parentName:"p"},"funciones.js")," "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="funci\xf3n enviarDatos() de loginVista.js"',title:'"funci\xf3n',"enviarDatos()":!0,de:!0,'loginVista.js"':!0},"// Funci\xf3n para enviar datos a la bd\n    function enviarDatos (formulario) {\n      const email = formulario.email.value\n      const pass = formulario.password.value\n\n      // buscamos el indice del email en el array perfiles\n      const indexUser = perfiles.findIndex((user) => user.email === email) // 1\n      // Si encuentra un usuario\n      if (indexUser > 0) {\n        // Si la contrase\xf1a es correcta\n        if (perfiles[indexUser].contrase\xf1a === pass) {\n          console.log('\xa1login correcto!')\n          const usuario = {\n            nombre: perfiles[indexUser].nombre,\n            apellidos: perfiles[indexUser].apellidos,\n            email: perfiles[indexUser].email,\n            rol: perfiles[indexUser].rol,\n            avatar: perfiles[indexUser].avatar,\n            user_id: perfiles[indexUser].user_id\n          }\n          // Guardamos datos de usaurio en localstorage\n          ls.setUsuario(usuario)\n          // Cargamos p\xe1gina home\n          window.location = '#/proyectos'\n          // Actualizamos el header para que se muestren los men\xfas que corresponden al rol\n          header.script()\n        } else {\n          // console.log('La contrase\xf1a no corresponde')\n          alert('El usuario no existe o la contrase\xf1a no es correcta')\n        }\n      } else {\n        // console.log('El usuario no existe')\n        alert('El usuario no existe o la contrase\xf1a no es correcta')\n      }\n    }\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Podr\xedamos indicar de manera independiente que el usuario no existe, o que s\xed existe pero la contrase\xf1a no corresponde, pero eso dar\xeda p\xedstas a un usuario que intente hackear el inicio de sesi\xf3n")),(0,o.kt)("p",null,"Para asegurarnos que, en nuestro ",(0,o.kt)("strong",{parentName:"p"},"men\xfa de usuario"),", se inyectan correctamente tanto el ",(0,o.kt)("strong",{parentName:"p"},"email")," como el ",(0,o.kt)("em",{parentName:"p"},"rol"),", vamos a a\xf1adir unas l\xedneas al final del header.js"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="header.js"',title:'"header.js"'},"\n... \n\n// Y actualizamos los datos de menu de usuario si es que se est\xe1 mostrando\n  try {\n    // email y rol\n    document.querySelector('#emailUserMenu').innerHTML = ls.getUsuario().email\n    document.querySelector('#rolUserMenu').innerHTML = ls.getUsuario().rol\n    // para la imagen de avatar (avatar.png si el campo est\xe1 vac\xedo)\n    const imagen = ls.getUsuario().avatar === '' ? 'images/avatar.svg' : ls.getUsuario().avatar\n    document.querySelector('#avatarMenu').setAttribute('src', imagen)\n  } catch (error) {\n    console.log('El usuario no est\xe1 registrado y no tiene men\xfa de usuario');\n  }\n")),(0,o.kt)("h2",{id:"cerrando-sesi\xf3n"},"Cerrando sesi\xf3n"),(0,o.kt)("p",null,"Para cerrar la sesi\xf3n, por el momento, simplemente ",(0,o.kt)("strong",{parentName:"p"},"vamos a borrar los datos del localstorage"),"."),(0,o.kt)("p",null,"Desde el script de ",(0,o.kt)("inlineCode",{parentName:"p"},"header.js")," detectamos cuando el usuario hace clic en el item de cerrar sesi\xf3n (con la clase asociada '",(0,o.kt)("em",{parentName:"p"},"cerrarSesion"),"')."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="header.js"',title:'"header.js"'},"\n...\n\n// Cerrar sesi\xf3n\n    // Capturamos clic sobre el item de cerrar sesi\xf3n\n    document.querySelector('header').addEventListener('click', (e) => {\n      if (e.target.classList.contains('cerrarSesion')) {\n        e.preventDefault()\n        // Borramos el localstorage\n        ls.setUsuario('')\n        // Cargamos la pagina home\n        window.location = '#/home'\n        header.script()\n      }\n    })\n")),(0,o.kt)("p",null,"Falta a\xf1adir la clase ",(0,o.kt)("strong",{parentName:"p"},"cerrarSesion")," a todos los items del men\xfa. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html",metastring:'title="menus.js"',title:'"menus.js"'},'<li><a class="dropdown-item cerrarSesion" href="#">Cerrar sesi\xf3n</a></li>\n')),(0,o.kt)("p",null,"Tambi\xe9n debes recordar importar el objeto ",(0,o.kt)("strong",{parentName:"p"},"ls"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="menu.js"',title:'"menu.js"'},"import { ls } from './funciones'\n")),(0,o.kt)("p",null,"Con todas las actualizaciones el ",(0,o.kt)("inlineCode",{parentName:"p"},"header.js"),"quedar\xeda as\xed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="header.js"',title:'"header.js"'},'// importamos la funci\xf3n ls del archivo funciones\nimport { ls } from \'../componentes/funciones\'\nimport { menuRol, menuUsuario } from \'./menus\'\nimport { editarPerfil } from \'./editarPerfil\'\n\nexport const header = {\n  template: // html\n  `\n<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">\n  <div class="container">\n    <a class="navbar-brand router-link" href="#/home"\n      ><img\n        src="images/logo.svg"\n        alt=""\n        width="30"\n        height="24"\n        class="d-inline-block align-text-top"\n      />\n\n      Vanilla Games</a\n    >\n    <button\n      class="navbar-toggler"\n      type="button"\n      data-bs-toggle="collapse"\n      data-bs-target="#navbarSupportedContent"\n      aria-controls="navbarSupportedContent"\n      aria-expanded="false"\n      aria-label="Toggle navigation"\n    >\n      <span class="navbar-toggler-icon"></span>\n    </button>\n    <div class="collapse navbar-collapse" id="navbarSupportedContent">\n      <ul class="navbar-nav mx-auto mb-2 mb-lg-0">\n        <li class="nav-item">\n          <a class="nav-link active router-link" aria-current="page" href="#/home">Home</a>\n        </li>\n        <li class="nav-item">\n          <a class="nav-link router-link" aria-current="page" href="#">TOP5 Proyectos</a>\n        </li>\n        <li class="nav-item">\n          <a class="nav-link router-link" aria-current="page" href="#" class="router-link">A cerca de</a>\n        </li>\n      </ul>\n\n      <div id="menuRol"></div>\n      <div id="menuUsuario"></div>\n    </div>\n  </div>\n</nav>\n<div id="modal"></div>\n\n  `,\n  script: () => {\n    console.log(\'Header cargado\')\n    // Cargamos la ventana modal para editar perfil\n    document.querySelector(\'#modal\').innerHTML = editarPerfil.template\n    // Y ejecutamos su l\xf3gica\n    editarPerfil.script()\n    const rolUsuario = ls.getUsuario().rol\n    switch (rolUsuario) {\n      case \'registrado\':\n        // men\xfa rol\n        document.querySelector(\'#menuRol\').innerHTML = menuRol.templateRegistrado\n        // men\xfa usuario\n        document.querySelector(\'#menuUsuario\').innerHTML = menuUsuario.templateRegistrado\n        break\n      case \'desarrollador\':\n        // men\xfa rol\n        document.querySelector(\'#menuRol\').innerHTML = menuRol.templateDesarrollador\n        // men\xfa usuario\n        document.querySelector(\'#menuUsuario\').innerHTML = menuUsuario.templateDesarrollador\n        break\n      case \'admin\':\n        // men\xfa rol\n        document.querySelector(\'#menuRol\').innerHTML = menuRol.templateAdmin\n        // men\xfa usuario\n        document.querySelector(\'#menuUsuario\').innerHTML = menuUsuario.templateAdmin\n        break\n      default : // Para usuarios an\xf3nimos\n        // men\xfa rol\n        document.querySelector(\'#menuRol\').innerHTML = menuRol.templateAnonimo\n        // men\xfa usuario - No debe aparecer nada\n        document.querySelector(\'#menuUsuario\').innerHTML = \'\'\n        break\n    }\n\n    // Y actualizamos los datos de menu de usuario si es que se est\xe1 mostrando\n    try {\n      // email y rol\n      document.querySelector(\'#emailUserMenu\').innerHTML = ls.getUsuario().email\n      document.querySelector(\'#rolUserMenu\').innerHTML = ls.getUsuario().rol\n      // para la imagen de avatar (avatar.png si el campo est\xe1 vac\xedo)\n      const imagen = ls.getUsuario().avatar === \'\' ? \'images/avatar.svg\' : ls.getUsuario().avatar\n      document.querySelector(\'#avatarMenu\').setAttribute(\'src\', imagen)\n    } catch (error) {\n      console.log(\'El usuario no est\xe1 registrado y no tiene men\xfa de usuario\')\n    }\n\n    // Cerrar sesi\xf3n\n    // Capturamos clic sobre el item de cerrar sesi\xf3n\n    document.querySelector(\'header\').addEventListener(\'click\', (e) => {\n      if (e.target.classList.contains(\'cerrarSesion\')) {\n        e.preventDefault()\n        // Borramos el localstorage\n        ls.setUsuario(\'\')\n        // Cargamos la pagina home\n        window.location = \'#/home\'\n        header.script()\n      }\n    })\n  }\n}\n\n')))}m.isMDXComponent=!0}}]);